name: Java CI/CD with Gradle and Docker
 on:
   push:
     branches: [ "main" ]
   pull_request:
     branches: [ "main" ]
 permissions:
   contents: read
 jobs:
   build:
     runs-on: ubuntu-latest
   steps:
   - uses: actions/checkout@v3
   - name: Set up Java 17
     uses: actions/setup-java@v3
     with:
       java-version: '17'
       distribution: 'corretto'
   - name: Make application.yml
     run: |
         cd ./src/main/resources
         touch ./application.yml
         echo "${{ secrets.PROPERTIES }}" > ./application.yml
     shell: bash	 
   - name: Build with Gradle
     run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test
   - name: Docker build & push to docker repo
     run: |
          docker login -u ${{ secrets.DOCKER_ID }} -p ${{ secrets.DOCKER_PWD }}
          docker build -f Dockerfile -t ${{ secrets.DOCKER_REPO }}/directors-dev .
          docker push ${{ secrets.DOCKER_REPO }}/directors-dev
   - name: Deploy to server
     uses: appleboy/ssh-action@master
     id: deploy
     with:
       host: ${{ secrets.SSH_HOST }}
       username: ec2-user
       key: ${{ secrets.SSH_PWD }}
       envs: GITHUB_SHA
     script: |
       sudo docker rm -f $(docker ps -qa)
       sudo docker pull ${{ secrets.DOCKER_REPO }}/directors-dev
       docker-compose up -d
       docker image prune -f
